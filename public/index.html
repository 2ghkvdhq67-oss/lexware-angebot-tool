<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Maiershirts â€” Lexoffice Angebots-Tool</title>

<style>
body { font-family: Arial; padding: 24px; }
h2 { margin-bottom: 8px; }

.box {
  border: 1px solid #ddd;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 12px;
}

button { padding: 8px 12px; margin-right: 8px; }

#log { white-space: pre-wrap; font-family: monospace; }

.ok { color: green; }
.err { color: red; }
.info { color: #444; }
</style>
</head>

<body>

<h2>Maiershirts â€” Lexoffice Angebots-Tool</h2>

<div class="box">
  <label>Tool-Passwort:</label><br>
  <input id="password" type="password">
</div>

<div class="box">
  <label>Excel Datei:</label><br>
  <input id="file" type="file" accept=".xlsx">
</div>

<div class="box">
  <label>
    <input type="checkbox" id="override">
    Artikelpreis Ã¼berschreiben erlauben
  </label>
</div>

<div class="box">
  <button id="btnTest">Testmodus ausfÃ¼hren</button>
  <button id="btnOffer">Angebot erstellen</button>
  <button id="btnPdf">PDF herunterladen</button>
</div>

<div class="box">
  <strong>Systemstatus:</strong><br>
  <div id="sys" class="info">Wird geprÃ¼ftâ€¦</div>
</div>

<div class="box">
  <strong>Protokoll:</strong><br>
  <div id="log"></div>
</div>

<script>
async function readFileBase64(file) {
  return new Promise(resolve => {
    const r = new FileReader();
    r.onload = () => resolve(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

function log(msg, cls="") {
  const el = document.getElementById("log");
  const div = document.createElement("div");
  if (cls) div.className = cls;
  div.textContent = msg;
  el.prepend(div);
}

async function callApi(endpoint) {
  const file = document.getElementById("file").files[0];
  if (!file) return log("Bitte Excel auswÃ¤hlen", "err");

  const excelData = await readFileBase64(file);
  const password = document.getElementById("password").value;
  const allowPriceOverride = document.getElementById("override").checked;

  const res = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ excelData, password, allowPriceOverride })
  });

  const data = await res.json();

  if (!data.ok) {
    if (data.status === "RATE_LIMIT") {
      return log("âš ï¸ Rate-Limit â€” spÃ¤ter erneut versuchen", "err");
    }
    return log("âŒ Fehler: " + (data.message || "Unbekannt"), "err");
  }

  if (data?.data?.quotationId) {
    return log("âœ… Angebot erstellt â€” ID: " + data.data.quotationId, "ok");
  }

  log("ðŸŸ¢ Test erfolgreich â€” keine Fehler", "ok");
}

document.getElementById("btnTest").onclick  = () => callApi("/api/test-excel");
document.getElementById("btnOffer").onclick = () => callApi("/api/create-offer");

// Placeholder â€” Backend-PDF kommt spÃ¤ter optional
document.getElementById("btnPdf").onclick = () =>
  log("ðŸ“„ PDF-Download folgt (Endpoint kann ergÃ¤nzt werden)", "info");

// Systemstatus
fetch("/api/ping")
 .then(r => r.json())
 .then(d => {
   document.getElementById("sys").textContent =
     "Backend erreichbar â€” Rate-Limiter " +
     d.minIntervalMs + "ms â€” Passwort: " +
     (d.passwordProtected ? "aktiv" : "aus");
 });
</script>

</body>
</html>
