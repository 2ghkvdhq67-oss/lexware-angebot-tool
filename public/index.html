<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Maiershirts ‚Äî Lexware Angebots-Tool</title>
<style>
body { font-family: Arial, sans-serif; padding: 24px; max-width: 1100px; margin: 0 auto; }
h2 { margin-bottom: 10px; }
.box { border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin-bottom: 12px; }
.row { display: flex; gap: 12px; flex-wrap: wrap; }
.col { flex: 1 1 420px; }
button { padding: 8px 12px; margin-right: 8px; cursor: pointer; }
button[disabled] { opacity: .6; cursor: not-allowed; }
textarea { width: 100%; min-height: 140px; padding: 10px; }
#log { white-space: pre-wrap; font-family: ui-monospace, Menlo, Consolas, monospace; max-height: 420px; overflow-y: auto; background: #0b0b0b; color: #eaeaea; padding: 10px; border-radius: 6px; }
.ok{color:#39d353;} .err{color:#ff6b6b;} .info{color:#c9d1d9;} .muted{color:#9aa4ad;}
.error-item { margin-left: 10px; font-size: 13px; color: #ffb4b4; }
.hr { border-top: 1px dashed rgba(255,255,255,.25); margin: 8px 0; }
.small { font-size: 12px; color: #555; }
</style>
</head>
<body>

<h2>Maiershirts ‚Äî Lexware Angebots-Tool</h2>

<div class="row">
  <div class="col">
    <div class="box">
      <button id="btnTemplate">Excel-Template herunterladen</button>
      <div class="small">Dynamisch: <code>/api/template.xlsx</code> (Artikel-Lookup max. alle 10 Minuten aktualisiert)</div>
    </div>

    <div class="box">
      <label>Tool-Passwort:</label><br>
      <input id="password" type="password" />
      <div class="small">Wird f√ºr Downloads per Header <code>x-tool-password</code> mitgesendet.</div>
    </div>

    <div class="box">
      <label>Excel-Datei (.xlsx):</label><br>
      <input id="file" type="file" accept=".xlsx" />
    </div>

    <div class="box">
      <label><input id="override" type="checkbox" /> Artikelpreis √ºberschreiben erlauben</label>
      <label style="margin-left:12px;"><input id="finalizeFlag" type="checkbox" /> Beim Erstellen finalisieren</label>
      <div class="small">Finalisieren geht per API nur beim Erstellen (nicht nachtr√§glich).</div>
    </div>

    <div class="box">
      <button id="btnTest">Testmodus ausf√ºhren</button>
      <button id="btnOffer">Angebot erstellen</button>
      <button id="btnFinalize">Angebot finalisieren</button>
      <button id="btnPdf" disabled>PDF herunterladen</button>
    </div>

    <div class="box">
      <strong>Phase 1 Komfort: Text einf√ºgen</strong><br>
      <div class="small">Text aus Kundenanfrage/Lieferschein hier reinkopieren (Zeilen/Tabs ok).</div>
      <textarea id="paste" placeholder="Beispiel:
25 Stk DTF Druck Brust 10x8 cm
12x B&C E190 wei√ü L
Hinweis: Druckfreigabe erforderlich, Lieferzeit 7-10 Tage"></textarea>
      <div style="margin-top:8px;">
        <button id="btnParse">Positionen erkennen</button>
        <button id="btnTextExcel" disabled>Excel aus Text herunterladen</button>
      </div>
    </div>

    <div class="box">
      <strong>Systemstatus:</strong><br>
      <div id="sys" class="small">Wird gepr√ºft‚Ä¶</div>
      <div class="small">Letzte Angebots-ID: <b id="qid">‚Äî</b></div>
    </div>
  </div>

  <div class="col">
    <div class="box">
      <strong>Protokoll:</strong><br>
      <div id="log"></div>
    </div>
  </div>
</div>

<script>
let lastQuotationId = null;
let lastParsedText = "";

function nowTs(){const d=new Date();const p=n=>String(n).padStart(2,'0');return `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;}
function escapeHtml(s){return String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}
function log(msg, cls="info"){const el=document.getElementById("log");const div=document.createElement("div");div.innerHTML=`<span class="muted">[${nowTs()}]</span> <span class="${cls}">${escapeHtml(msg)}</span>`;el.prepend(div);}
function logLine(){const el=document.getElementById("log");const div=document.createElement("div");div.className="hr";el.prepend(div);}

function logErrorsFromSummary(summary){
  if(!summary||!Array.isArray(summary.errors)||!summary.errors.length) return;
  log('Details zu den Fehlern:', 'info');
  summary.errors.forEach(err=>{
    const line=[err.sheet?`[${err.sheet}]`:'',err.row?`Zeile ${err.row}`:'',err.field?`Feld "${err.field}"`:'','‚Üí',err.message||''].filter(Boolean).join(' ');
    log('  - '+line,'error-item');
  });
}

function logLexwareApi(technical){
  logLine(); log('‚Äî‚Äî Lexware API ‚Äî‚Äî','info');
  if(!technical){ log('Keine technical-Daten vorhanden.','err'); return; }
  if(technical.httpStatus) log('HTTP-Status: '+technical.httpStatus,'info');
  const meta=technical.meta||{};
  if(meta.requestId) log('requestId: '+meta.requestId,'info');
  if(meta.traceId) log('traceId: '+meta.traceId,'info');
  if(meta.path) log('path: '+meta.path,'info');
  if(meta.timestamp) log('timestamp: '+meta.timestamp,'info');
  if(meta.message) log('message: '+meta.message,'info');
  if(Array.isArray(meta.details)&&meta.details.length){
    log('details:','info');
    meta.details.forEach(d=>{
      const line=[d.field?d.field:'',d.violation?`(${d.violation})`:'',d.message?`‚Üí ${d.message}`:''].filter(Boolean).join(' ');
      log('  - '+line,'error-item');
    });
  }
  if(technical.raw){
    try{ log('raw:\n'+JSON.stringify(technical.raw,null,2),'info'); }
    catch{ log('raw: '+String(technical.raw),'info'); }
  }
}

async function readFileBase64(file){
  return new Promise(resolve=>{
    const r=new FileReader();
    r.onload=()=>resolve(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

async function callApi(endpoint, extraBody={}){
  const fileInput=document.getElementById("file");
  const password=document.getElementById("password").value;
  const allowPriceOverride=document.getElementById("override").checked;

  if(!fileInput.files[0]){ log("Bitte zuerst eine Excel-Datei ausw√§hlen.","err"); return; }
  const excelData=await readFileBase64(fileInput.files[0]);

  let data;
  try{
    const res=await fetch(endpoint,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ excelData, password, allowPriceOverride, ...extraBody })
    });
    data=await res.json();
  }catch(e){
    console.error(e);
    log("‚ùå Netzwerk- oder Serverfehler beim API-Aufruf.","err");
    return;
  }

  if(!data.ok){
    log(`‚ùå Fehler (${data.status||"ERROR"}): ${data.message||"Unbekannt"}`,"err");
    if(data.data&&data.data.summary) logErrorsFromSummary(data.data.summary);
    logLexwareApi(data.technical||null);
    return;
  }

  if(data.data&&data.data.quotationId){
    lastQuotationId=data.data.quotationId;
    document.getElementById("qid").textContent=lastQuotationId;
    document.getElementById("btnPdf").disabled=false;
    log("‚úÖ Angebot erstellt ‚Äî ID: "+lastQuotationId,"ok");
  } else {
    log("üü¢ Test erfolgreich ‚Äî keine kritischen Fehler.","ok");
  }
}

document.getElementById("btnTemplate").onclick = async ()=>{
  const password=document.getElementById("password").value;
  try{
    log("Template wird geladen ‚Ä¶","info");
    const res=await fetch("/api/template.xlsx",{ headers: password?{"x-tool-password":password}:{ } });
    const blob=await res.blob();
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="lexware_template.xlsx";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    log("‚úÖ Template Download gestartet.","ok");
  }catch(e){
    console.error(e);
    log("‚ùå Template Download fehlgeschlagen.","err");
  }
};

document.getElementById("btnTest").onclick = ()=>callApi("/api/test-excel");

document.getElementById("btnOffer").onclick = ()=>{
  const finalize = document.getElementById("finalizeFlag").checked;
  callApi("/api/create-offer", { finalize });
};

document.getElementById("btnFinalize").onclick = ()=>{
  if(lastQuotationId){
    log("‚ÑπÔ∏è Bereits eine Angebots-ID vorhanden. Nachtr√§gliches Finalisieren geht per API nicht. Bitte beim Erstellen finalisieren oder in Lexware finalisieren.","info");
    return;
  }
  document.getElementById("finalizeFlag").checked = true;
  callApi("/api/create-offer", { finalize: true });
};

document.getElementById("btnPdf").onclick = async ()=>{
  if(!lastQuotationId){ log("Bitte zuerst ein Angebot erstellen, dann PDF laden.","err"); return; }
  const password=document.getElementById("password").value;
  try{
    log("PDF wird geladen ‚Ä¶","info");
    const res=await fetch("/api/download-pdf?id="+encodeURIComponent(lastQuotationId),{ headers: password?{"x-tool-password":password}:{ } });
    const ct=(res.headers.get("content-type")||"").toLowerCase();
    if(ct.includes("application/json")){
      const data=await res.json();
      if(!data.ok){ log(`‚ùå Fehler (${data.status||"ERROR"}): ${data.message||"PDF Download fehlgeschlagen"}`,"err"); logLexwareApi(data.technical||null); return; }
    }
    const blob=await res.blob();
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="angebot.pdf";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    log("‚úÖ PDF Download gestartet.","ok");
  }catch(e){
    console.error(e);
    log("‚ùå PDF Download fehlgeschlagen.","err");
  }
};

document.getElementById("btnParse").onclick = async ()=>{
  const password=document.getElementById("password").value;
  const text=document.getElementById("paste").value.trim();
  if(!text){ log("Bitte zuerst Text einf√ºgen.","err"); return; }
  lastParsedText=text;
  document.getElementById("btnTextExcel").disabled=true;

  try{
    log("Parser l√§uft ‚Ä¶","info");
    const res=await fetch("/api/parse-text",{
      method:"POST",
      headers:{ "Content-Type":"application/json", ...(password?{"x-tool-password":password}:{ }) },
      body:JSON.stringify({ text })
    });
    const data=await res.json();
    if(!data.ok){ log(`‚ùå Fehler (${data.status||"ERROR"}): ${data.message||"Parser Fehler"}`,"err"); logLexwareApi(data.technical||null); return; }

    const items=data.data?.items||[];
    const warnings=data.data?.warnings||[];

    log(`‚úÖ Erkannt: ${items.length} Position(en)`,"ok");
    items.slice(0,50).forEach((it,i)=>{
      const qty=(it.type==='text')?'':(it.quantity??'');
      const unit=(it.type==='text')?'':(it.unitName||'');
      const sku=it.articleNumber?` | SKU: ${it.articleNumber}`:'';
      const aid=it.articleId?` | articleId: ${it.articleId}`:'';
      log(`  ${i+1}. [${it.type}] ${qty} ${unit} ‚Äî ${it.name}${sku}${aid}`,"info");
      if(it.description) log(`      desc: ${it.description}`,"muted");
    });

    if(warnings.length){
      log(`‚ö†Ô∏è Parser Hinweise (${warnings.length}):`,"info");
      warnings.forEach(w=>log(`  - Zeile ${w.line}: ${w.message}`,"muted"));
    }

    document.getElementById("btnTextExcel").disabled=false;
  }catch(e){
    console.error(e);
    log("‚ùå Parser Fehler (Netzwerk/Server).","err");
  }
};

document.getElementById("btnTextExcel").onclick = async ()=>{
  const password=document.getElementById("password").value;
  if(!lastParsedText){ log("Bitte zuerst 'Positionen erkennen' ausf√ºhren.","err"); return; }
  try{
    log("Excel aus Text wird erstellt ‚Ä¶","info");
    const url="/api/text-to-excel?taxType=net&text="+encodeURIComponent(lastParsedText);
    const res=await fetch(url,{ headers: password?{"x-tool-password":password}:{ } });

    const ct=(res.headers.get("content-type")||"").toLowerCase();
    if(ct.includes("application/json")){
      const data=await res.json();
      if(!data.ok){ log(`‚ùå Fehler (${data.status||"ERROR"}): ${data.message||"Text‚ÜíExcel fehlgeschlagen"}`,"err"); logLexwareApi(data.technical||null); return; }
    }

    const blob=await res.blob();
    const dlUrl=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=dlUrl; a.download="from_text.xlsx";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(dlUrl);
    log("‚úÖ Download gestartet: from_text.xlsx","ok");
  }catch(e){
    console.error(e);
    log("‚ùå Text‚ÜíExcel Download fehlgeschlagen.","err");
  }
};

fetch("/api/ping")
  .then(r=>r.json())
  .then(d=>{
    const sys=document.getElementById("sys");
    if(!d.ok){ sys.textContent="Backend antwortet, aber ok=false."; return; }
    sys.textContent="Backend erreichbar ‚Äî Passwort: "+(d.passwordProtected?"aktiv":"aus")+" ‚Äî Template TTL: "+Math.round((d.templateTtlMs||0)/60000)+" min";
  })
  .catch(()=>{ document.getElementById("sys").textContent="‚ùå Backend nicht erreichbar."; });
</script>

</body>
</html>
