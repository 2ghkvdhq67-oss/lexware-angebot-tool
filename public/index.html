<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Maiershirts ‚Äî Lexoffice Angebots-Tool</title>

<style>
  body { font-family: Arial, sans-serif; padding: 24px; }
  h2 { margin-bottom: 10px; }
  .box {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 12px;
  }
  .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
  button {
    padding: 8px 12px;
    margin-right: 8px;
    cursor: pointer;
  }
  button.secondary { opacity: 0.9; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  #log {
    white-space: pre-wrap;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    max-height: 360px;
    overflow-y: auto;
    border: 1px solid #eee;
    border-radius: 6px;
    padding: 10px;
    background: #fafafa;
  }
  .ok  { color: #0a7a2f; }
  .err { color: #b00020; }
  .info { color: #444; }
  .muted { color: #666; font-size: 12px; }
  .kv { margin-top: 6px; font-size: 12px; color: #333; }
  .error-item { margin-left: 10px; font-size: 13px; }
  .sep { height: 1px; background: #eee; margin: 10px 0; }
</style>
</head>

<body>

<h2>Maiershirts ‚Äî Lexoffice Angebots-Tool</h2>

<div class="box">
  <div class="row">
    <div style="min-width:260px;">
      <label>Tool-Passwort:</label><br>
      <input id="password" type="password" style="width:240px;" />
      <div class="muted">Wird f√ºr API-Aufrufe & Downloads verwendet.</div>
    </div>

    <div style="min-width:320px;">
      <label>Excel-Datei (.xlsx):</label><br>
      <input id="file" type="file" accept=".xlsx" />
      <div class="muted">Nutze das Template, damit Validierungen & Dropdowns passen.</div>
    </div>
  </div>
</div>

<div class="box">
  <label>
    <input id="override" type="checkbox" />
    Artikelpreis √ºberschreiben erlauben
  </label>
  <div class="muted">Wenn aktiv, darf Excel-Preis auch bei Artikelpositionen verwendet werden (falls Backend so konfiguriert).</div>
</div>

<div class="box">
  <div class="row">
    <button id="btnTemplateAuto" class="secondary">Template herunterladen (Auto / TTL)</button>
    <button id="btnTemplateStatic" class="secondary">Template herunterladen (statisch)</button>
  </div>
  <div class="muted">‚ÄûAuto‚Äú zieht Artikel-Lookup dynamisch (mit Cache/TTL). ‚ÄûStatisch‚Äú ist die Datei aus /templates.</div>
</div>

<div class="box">
  <div class="row">
    <button id="btnTest">Testmodus ausf√ºhren</button>

    <button id="btnOfferDraft">Angebot erstellen (Entwurf)</button>
    <button id="btnOfferFinalize">Finalisieren & Angebot erstellen</button>

    <button id="btnPdf" disabled>PDF herunterladen</button>
  </div>
  <div class="muted">
    Entwurf = erstellen ohne Finalisierung. Finalisieren = Angebot wird ‚Äûfest‚Äú (weniger √Ñnderungen, PDF ready).
  </div>
</div>

<div class="box">
  <strong>Systemstatus:</strong><br>
  <div id="sys" class="info">Wird gepr√ºft‚Ä¶</div>
  <div id="sys2" class="muted"></div>
</div>

<div class="box">
  <strong>Protokoll (chronologisch):</strong><br>
  <div id="log"></div>
</div>

<script>
let lastQuotationId = null;

function nowTime() {
  const d = new Date();
  return d.toLocaleString();
}

async function readFileBase64(file) {
  return new Promise(resolve => {
    const r = new FileReader();
    r.onload = () => resolve(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

function logLine(msg, cls = "info") {
  const el = document.getElementById("log");
  const div = document.createElement("div");
  div.className = cls || "";
  div.textContent = `[${nowTime()}] ${msg}`;
  // ‚úÖ chronologisch: neue Zeilen UNTEN
  el.appendChild(div);
  el.scrollTop = el.scrollHeight;
}

function logJson(title, obj, cls="info") {
  logLine(title, cls);
  try {
    const pretty = JSON.stringify(obj, null, 2);
    logLine(pretty, cls);
  } catch {
    logLine(String(obj), cls);
  }
}

function logErrorsFromSummary(summary) {
  if (!summary || !Array.isArray(summary.errors) || !summary.errors.length) return;

  logLine('Details zu den Fehlern:', 'info');
  summary.errors.forEach(err => {
    const line = [
      err.sheet ? `[${err.sheet}]` : '',
      err.row ? `Zeile ${err.row}` : '',
      err.field ? `Feld "${err.field}"` : '',
      '‚Üí',
      err.message || ''
    ].filter(Boolean).join(' ');
    logLine('  - ' + line, 'err');
  });
}

function logWarningsFromSummary(summary) {
  if (!summary || !Array.isArray(summary.warnings) || !summary.warnings.length) return;
  logLine('Hinweise / Warnungen:', 'info');
  summary.warnings.forEach(w => {
    const line = [
      w.sheet ? `[${w.sheet}]` : '',
      w.row ? `Zeile ${w.row}` : '',
      '‚Üí',
      w.message || ''
    ].filter(Boolean).join(' ');
    logLine('  - ' + line, 'info');
  });
}

function getAuthHeaders() {
  const password = document.getElementById("password").value;
  const headers = {};
  if (password) headers["x-tool-password"] = password;
  return headers;
}

async function callApi(endpoint, extraBody = {}) {
  const fileInput = document.getElementById("file");
  const password = document.getElementById("password").value;
  const allowPriceOverride = document.getElementById("override").checked;

  if (!fileInput.files[0]) {
    logLine("Bitte zuerst eine Excel-Datei ausw√§hlen.", "err");
    return null;
  }

  const excelData = await readFileBase64(fileInput.files[0]);

  let data;
  try {
    const res = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...getAuthHeaders() },
      body: JSON.stringify({ excelData, password, allowPriceOverride, ...extraBody })
    });

    data = await res.json();
  } catch (e) {
    console.error(e);
    logLine("‚ùå Netzwerk- oder Serverfehler beim API-Aufruf.", "err");
    return null;
  }

  console.log("API Antwort:", data);

  if (!data.ok) {
    const status = data.status || 'UNBEKANNT';
    const msg = data.message || 'Keine genaue Fehlermeldung vorhanden.';
    logLine(`‚ùå Fehler (${status}): ${msg}`, "err");

    // ‚úÖ Technical Details immer sichtbar
    if (data.technical) {
      logJson("‚Äî‚Äî Technical (Lexware/Lexoffice API) ‚Äî‚Äî", data.technical, "info");
    }

    // Summary Errors
    if (data.data && data.data.summary) {
      logErrorsFromSummary(data.data.summary);
      logWarningsFromSummary(data.data.summary);
    }

    return data;
  }

  // Erfolg
  if (data.data && data.data.quotationId) {
    lastQuotationId = data.data.quotationId;
    document.getElementById("btnPdf").disabled = false;
    logLine("‚úÖ Angebot erstellt ‚Äî Quotation ID: " + lastQuotationId, "ok");
  } else {
    logLine("üü¢ Test erfolgreich ‚Äî keine kritischen Fehler.", "ok");
  }

  if (data.data && data.data.summary) {
    logWarningsFromSummary(data.data.summary);
  }

  return data;
}

// --- Buttons ---
document.getElementById("btnTest").onclick = () => {
  logLine("Starte Testmodus‚Ä¶", "info");
  callApi("/api/test-excel");
};

document.getElementById("btnOfferDraft").onclick = () => {
  logLine("Erstelle Angebot als ENTWURF (finalize=false)‚Ä¶", "info");
  callApi("/api/create-offer", { finalize: false });
};

document.getElementById("btnOfferFinalize").onclick = () => {
  logLine("Erstelle & FINALISIERE Angebot (finalize=true)‚Ä¶", "info");
  callApi("/api/create-offer", { finalize: true });
};

// Template Download
document.getElementById("btnTemplateAuto").onclick = async () => {
  const pw = document.getElementById("password").value;
  const url = pw ? `/api/template.xlsx?password=${encodeURIComponent(pw)}` : `/api/template.xlsx`;
  logLine("Lade Template (Auto/TTL)‚Ä¶", "info");
  window.location.href = url;
};

document.getElementById("btnTemplateStatic").onclick = () => {
  logLine("Lade Template (statisch)‚Ä¶", "info");
  window.location.href = `/templates/lexware_template.xlsx`;
};

// PDF Download
document.getElementById("btnPdf").onclick = () => {
  if (!lastQuotationId) {
    logLine("Keine Quotation ID vorhanden. Bitte zuerst Angebot erstellen.", "err");
    return;
  }
  const pw = document.getElementById("password").value;
  const url = pw
    ? `/api/download-pdf?id=${encodeURIComponent(lastQuotationId)}&password=${encodeURIComponent(pw)}`
    : `/api/download-pdf?id=${encodeURIComponent(lastQuotationId)}`;

  logLine("Lade PDF‚Ä¶", "info");
  window.location.href = url;
};

// Systemstatus pr√ºfen
fetch("/api/ping", { headers: { ...getAuthHeaders() } })
  .then(r => r.json())
  .then(d => {
    const sys = document.getElementById("sys");
    const sys2 = document.getElementById("sys2");

    if (!d.ok) {
      sys.textContent = "Backend antwortet, aber ok=false.";
      return;
    }

    sys.textContent =
      `Backend erreichbar ‚Äî Rate-Limiter: ${d.minIntervalMs} ms ‚Äî Passwort: ${d.passwordProtected ? "aktiv" : "aus"}`;

    sys2.textContent =
      `Finalize-Default: ${d.finalizeDefault ? "true" : "false"} ‚Ä¢ Template TTL: ${Math.round((d.templateTtlMs||0)/60000)} min ‚Ä¢ API: ${d.apiBaseUrl}`;
  })
  .catch(() => {
    document.getElementById("sys").textContent = "‚ùå Backend nicht erreichbar.";
  });
</script>

</body>
</html>
