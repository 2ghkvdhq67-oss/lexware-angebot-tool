<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Maiershirts ‚Äî Lexoffice Angebots-Tool</title>

<style>
  body { font-family: Arial, sans-serif; padding: 24px; }
  h2 { margin-bottom: 10px; }

  .box {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 12px;
  }

  label { font-weight: 600; }

  input[type="password"], input[type="file"] {
    margin-top: 6px;
  }

  button {
    padding: 8px 12px;
    margin-right: 8px;
    cursor: pointer;
  }

  button.secondary { opacity: 0.92; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }

  .muted { color: #666; font-size: 12px; margin-top: 6px; line-height: 1.35; }

  .row { display: flex; gap: 14px; flex-wrap: wrap; align-items: center; }

  #log {
    white-space: pre-wrap;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    max-height: 360px;
    overflow-y: auto;
    border: 1px solid #eee;
    border-radius: 6px;
    padding: 10px;
    background: #fafafa;
  }

  .ok  { color: #0a7a2f; }
  .err { color: #b00020; }
  .info { color: #333; }
  .warn { color: #8a5a00; }

  .pill {
    display: inline-block;
    border: 1px solid #ddd;
    border-radius: 999px;
    padding: 6px 10px;
    background: #fff;
  }
</style>
</head>

<body>

<h2>Maiershirts ‚Äî Lexoffice Angebots-Tool</h2>

<!-- 1) Passwort (oben) -->
<div class="box">
  <label>Tool-Passwort</label><br>
  <input id="password" type="password" style="width:280px;" autocomplete="current-password" />
  <div class="muted">
    Wird f√ºr API-Aufrufe und Downloads verwendet.
  </div>
</div>

<!-- 2) Excel (darunter) -->
<div class="box">
  <label>Excel-Datei (.xlsx)</label><br>
  <input id="file" type="file" accept=".xlsx" />
  <div class="muted">
    Tipp: Nutze das Template, damit Dropdowns/Validierungen passen.
  </div>
</div>

<!-- 3) Optionen -->
<div class="box">
  <div class="row">
    <label class="pill">
      <input type="radio" name="mode" id="modeFinal" value="final" checked />
      Final (fertig)
    </label>

    <label class="pill">
      <input type="radio" name="mode" id="modeDraft" value="draft" />
      Entwurf
    </label>

    <label class="pill" title="Wenn aktiv, darf Excel-Preis auch bei Artikelpositionen verwendet werden (falls Backend konfiguriert).">
      <input id="override" type="checkbox" />
      Artikelpreis √ºberschreiben erlauben
    </label>
  </div>

  <div class="muted">
    Hinweis: <b>Ein Entwurf kann per API nicht nachtr√§glich ‚Äûfinalisiert‚Äú werden.</b>
    Wenn du nach einem Entwurf sp√§ter ‚ÄûFinal‚Äú erstellst, entsteht ein <b>neues Angebot</b> mit <b>neuer Angebotsnummer</b>.
  </div>
</div>

<!-- 4) Aktionen -->
<div class="box">
  <div class="row">
    <button id="btnTemplateAuto" class="secondary">Template herunterladen (Auto / TTL)</button>
    <button id="btnTemplateStatic" class="secondary">Template herunterladen (statisch)</button>
  </div>
  <div class="muted">
    Auto = Artikel-Lookup wird serverseitig aktualisiert (Cache/TTL). Statisch = Datei aus /templates.
  </div>
</div>

<div class="box">
  <div class="row">
    <button id="btnTest">Testmodus ausf√ºhren</button>
    <button id="btnCreate">Angebot erstellen</button>
    <button id="btnPdf" disabled>PDF herunterladen</button>
  </div>
</div>

<div class="box">
  <strong>Systemstatus:</strong><br>
  <div id="sys" class="info">Wird gepr√ºft‚Ä¶</div>
  <div id="sys2" class="muted"></div>
</div>

<div class="box">
  <strong>Protokoll (chronologisch):</strong><br>
  <div id="log"></div>
</div>

<script>
let lastOfferId = null;   // technisch: quotationId
let lastMode = "final";

function nowTime() {
  const d = new Date();
  return d.toLocaleString();
}

function logLine(msg, cls = "info") {
  const el = document.getElementById("log");
  const div = document.createElement("div");
  div.className = cls || "";
  div.textContent = `[${nowTime()}] ${msg}`;
  el.appendChild(div);
  el.scrollTop = el.scrollHeight;
}

function logJson(title, obj, cls="info") {
  logLine(title, cls);
  try {
    logLine(JSON.stringify(obj, null, 2), cls);
  } catch {
    logLine(String(obj), cls);
  }
}

async function readFileBase64(file) {
  return new Promise(resolve => {
    const r = new FileReader();
    r.onload = () => resolve(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

function logErrorsFromSummary(summary) {
  if (!summary || !Array.isArray(summary.errors) || !summary.errors.length) return;
  logLine("Details zu den Fehlern:", "info");
  summary.errors.forEach(err => {
    const line = [
      err.sheet ? `[${err.sheet}]` : '',
      err.row ? `Zeile ${err.row}` : '',
      err.field ? `Feld "${err.field}"` : '',
      "‚Üí",
      err.message || ''
    ].filter(Boolean).join(" ");
    logLine("  - " + line, "err");
  });
}

function logWarningsFromSummary(summary) {
  if (!summary || !Array.isArray(summary.warnings) || !summary.warnings.length) return;
  logLine("Hinweise / Warnungen:", "warn");
  summary.warnings.forEach(w => {
    const line = [
      w.sheet ? `[${w.sheet}]` : '',
      w.row ? `Zeile ${w.row}` : '',
      "‚Üí",
      w.message || ''
    ].filter(Boolean).join(" ");
    logLine("  - " + line, "warn");
  });
}

function getMode() {
  return document.getElementById("modeDraft").checked ? "draft" : "final";
}

function getFinalizeBoolFromMode(mode) {
  return mode === "final";
}

function getAuthHeaders() {
  const password = document.getElementById("password").value;
  const headers = {};
  if (password) headers["x-tool-password"] = password;
  return headers;
}

async function callApi(endpoint, extraBody = {}) {
  const fileInput = document.getElementById("file");
  const password = document.getElementById("password").value;
  const allowPriceOverride = document.getElementById("override").checked;

  if (!fileInput.files[0]) {
    logLine("Bitte zuerst eine Excel-Datei ausw√§hlen.", "err");
    return null;
  }

  const excelData = await readFileBase64(fileInput.files[0]);

  let data;
  try {
    const res = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...getAuthHeaders() },
      body: JSON.stringify({ excelData, password, allowPriceOverride, ...extraBody })
    });
    data = await res.json();
  } catch (e) {
    console.error(e);
    logLine("‚ùå Netzwerk- oder Serverfehler beim API-Aufruf.", "err");
    return null;
  }

  if (!data.ok) {
    logLine(`‚ùå Fehler (${data.status || "UNBEKANNT"}): ${data.message || "Keine genaue Fehlermeldung vorhanden."}`, "err");
    if (data.technical) logJson("‚Äî‚Äî Technical (Lexware/Lexoffice API) ‚Äî‚Äî", data.technical, "info");
    if (data.data && data.data.summary) {
      logErrorsFromSummary(data.data.summary);
      logWarningsFromSummary(data.data.summary);
    }
    return data;
  }

  if (data.data && data.data.quotationId) {
    lastOfferId = data.data.quotationId;
    document.getElementById("btnPdf").disabled = false;
    logLine(`‚úÖ Angebot erstellt ‚Äî Angebots-ID: ${lastOfferId}`, "ok");
  } else {
    logLine("üü¢ Test erfolgreich ‚Äî keine kritischen Fehler.", "ok");
  }

  if (data.data && data.data.summary) {
    logWarningsFromSummary(data.data.summary);
  }

  return data;
}

// Buttons
document.getElementById("btnTest").onclick = () => {
  logLine("Starte Testmodus‚Ä¶", "info");
  callApi("/api/test-excel");
};

document.getElementById("btnCreate").onclick = () => {
  const mode = getMode();
  const finalize = getFinalizeBoolFromMode(mode);

  if (lastMode === "draft" && mode === "final") {
    logLine("Hinweis: ‚ÄûFinal‚Äú erstellt ein NEUES Angebot (neue Angebotsnummer). Ein Entwurf kann per API nicht nachtr√§glich finalisiert werden.", "warn");
  }

  lastMode = mode;
  logLine(`Erstelle Angebot im Modus: ${mode === "final" ? "FINAL" : "ENTWURF"} (finalize=${finalize})‚Ä¶`, "info");
  callApi("/api/create-offer", { finalize });
};

// Template Download
document.getElementById("btnTemplateAuto").onclick = () => {
  const pw = document.getElementById("password").value;
  const url = pw ? `/api/template.xlsx?password=${encodeURIComponent(pw)}` : `/api/template.xlsx`;
  logLine("Lade Template (Auto/TTL)‚Ä¶", "info");
  window.location.href = url;
};

document.getElementById("btnTemplateStatic").onclick = () => {
  logLine("Lade Template (statisch)‚Ä¶", "info");
  window.location.href = `/templates/lexware_template.xlsx`;
};

// PDF Download
document.getElementById("btnPdf").onclick = () => {
  if (!lastOfferId) {
    logLine("Keine Angebots-ID vorhanden. Bitte zuerst ein Angebot erstellen.", "err");
    return;
  }
  const pw = document.getElementById("password").value;
  const url = pw
    ? `/api/download-pdf?id=${encodeURIComponent(lastOfferId)}&password=${encodeURIComponent(pw)}`
    : `/api/download-pdf?id=${encodeURIComponent(lastOfferId)}`;

  logLine("Lade PDF‚Ä¶", "info");
  window.location.href = url;
};

// Systemstatus
fetch("/api/ping", { headers: { ...getAuthHeaders() } })
  .then(r => r.json())
  .then(d => {
    const sys = document.getElementById("sys");
    const sys2 = document.getElementById("sys2");

    if (!d.ok) {
      sys.textContent = "Backend antwortet, aber ok=false.";
      return;
    }

    sys.textContent =
      `Backend erreichbar ‚Äî Rate-Limiter: ${d.minIntervalMs} ms ‚Äî Passwort: ${d.passwordProtected ? "aktiv" : "aus"}`;

    sys2.textContent =
      `Finalize-Default: ${d.finalizeDefault ? "true" : "false"} ‚Ä¢ Template TTL: ${Math.round((d.templateTtlMs||0)/60000)} min ‚Ä¢ API: ${d.apiBaseUrl}`;
  })
  .catch(() => {
    document.getElementById("sys").textContent = "‚ùå Backend nicht erreichbar.";
  });
</script>

</body>
</html>
