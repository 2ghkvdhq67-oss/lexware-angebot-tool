<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Maiershirts ‚Äì Lexoffice Angebots-Tool</title>

<style>
  body { font-family: Arial, Helvetica, sans-serif; padding: 24px; }
  h2 { margin-bottom: 10px; }

  .box {
    border: 1px solid #ddd;
    padding: 12px;
    margin-bottom: 12px;
    border-radius: 6px;
  }

  button {
    padding: 8px 14px;
    margin-right: 10px;
    cursor: pointer;
  }

  #log {
    white-space: pre-wrap;
    font-family: monospace;
    margin-top: 10px;
  }

  .ok { color: green; }
  .err { color: red; }
  .info { color: #444; }
</style>
</head>

<body>

<h2>Maiershirts ‚Äî Lexoffice Angebots-Tool</h2>

<div class="box">
  <label>Tool-Passwort (falls aktiviert):</label><br>
  <input id="password" type="password" />
</div>

<div class="box">
  <label>Excel Datei:</label><br>
  <input id="file" type="file" accept=".xlsx" />
</div>

<div class="box">
  <label>
    <input type="checkbox" id="override" />
    Artikelpreis √ºberschreiben erlauben
  </label>
</div>

<div class="box">
  <button onclick="runTest()">Testmodus ausf√ºhren</button>
  <button onclick="runOffer()">Angebot erstellen</button>
</div>

<div class="box">
  <strong>Systemstatus:</strong>
  <div id="sys" class="info">Noch nicht gepr√ºft‚Ä¶</div>
</div>

<div class="box">
  <strong>Protokoll:</strong>
  <div id="log"></div>
</div>


<!-- ---------------------------------------------------
     JAVASCRIPT DIREKT HIER ‚Äì KEINE main.js N√ñTIG
---------------------------------------------------- -->
<script>
async function readFileBase64(file) {
  return new Promise(resolve => {
    const r = new FileReader();
    r.onload = () => resolve(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

function log(msg, cls="") {
  const el = document.getElementById("log");
  el.innerHTML = '<div class="'+cls+'">'+msg+'</div>' + el.innerHTML;
}

async function callApi(endpoint) {

  const file = document.getElementById("file").files[0];
  if (!file) return log("Bitte Excel ausw√§hlen", "err");

  const excelData = await readFileBase64(file);
  const password = document.getElementById("password").value;
  const allowPriceOverride = document.getElementById("override").checked;

  const res = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      password,
      excelData,
      allowPriceOverride
    })
  });

  const data = await res.json();
  console.log("Antwort", data);

  if (!data.ok) {

    if (data.status === "RATE_LIMIT")
      return log("‚ö†Ô∏è Rate-Limit ‚Äî Bitte sp√§ter erneut versuchen", "err");

    return log("‚ùå Fehler: " + (data.message || "Unbekannter Fehler"), "err");
  }

  if (data?.data?.quotationId)
    return log("‚úÖ Angebot erstellt ‚Äî ID: " + data.data.quotationId, "ok");

  log("üü¢ Test erfolgreich ‚Äî keine Blocking-Fehler", "ok");
}

function runTest()  { callApi("/api/test-excel"); }
function runOffer() { callApi("/api/create-offer"); }


// ---------------------------------------------
// Backend-Status pr√ºfen (Ping)
// ---------------------------------------------
async function checkSystem() {
  try {
    const r = await fetch("/api/ping");
    const d = await r.json();

    if (d.ok)
      document.getElementById("sys").innerText =
        "Backend erreichbar ‚Äî Rate-Limiter aktiv (" +
        d.minIntervalMs + "ms)";

    else
      document.getElementById("sys").innerText =
        "Backend antwortet, aber ok=false";
  }
  catch(e) {
    document.getElementById("sys").innerText =
      "‚ùå Backend nicht erreichbar";
  }
}

checkSystem();
</script>

</body>
</html>

