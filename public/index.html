<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Maiershirts ‚Äî Lexoffice Angebots-Tool</title>

<style>
body { font-family: Arial, sans-serif; padding: 24px; }
h2 { margin-bottom: 10px; }

.box {
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 12px;
}

button {
  padding: 8px 12px;
  margin-right: 8px;
  cursor: pointer;
}

#log {
  white-space: pre-wrap;
  font-family: monospace;
  max-height: 300px;
  overflow-y: auto;
}

.ok  { color: green; }
.err { color: red; }
.info { color: #444; }

.error-item { margin-left: 10px; font-size: 13px; }
</style>
</head>

<body>

<h2>Maiershirts ‚Äî Lexoffice Angebots-Tool</h2>

<div class="box">
  <button id="btnTemplate">Excel-Template herunterladen</button>
</div>

<div class="box">
  <label>Tool-Passwort:</label><br>
  <input id="password" type="password" />
</div>

<div class="box">
  <label>Excel-Datei (.xlsx):</label><br>
  <input id="file" type="file" accept=".xlsx" />
</div>

<div class="box">
  <label>
    <input id="override" type="checkbox" />
    Artikelpreis √ºberschreiben erlauben
  </label>
</div>

<div class="box">
  <button id="btnTest">Testmodus ausf√ºhren</button>
  <button id="btnOffer">Angebot erstellen</button>
</div>

<div class="box">
  <strong>Systemstatus:</strong><br>
  <div id="sys" class="info">Wird gepr√ºft‚Ä¶</div>
</div>

<div class="box">
  <strong>Protokoll:</strong><br>
  <div id="log"></div>
</div>

<script>
async function readFileBase64(file) {
  return new Promise(resolve => {
    const r = new FileReader();
    r.onload = () => resolve(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

function log(msg, cls = "") {
  const el = document.getElementById("log");
  const d = document.createElement("div");
  if (cls) d.className = cls;
  d.textContent = msg;
  el.prepend(d);
}

function logErrors(summary) {
  if (!summary?.errors?.length) return;
  log("Details zu den Fehlern:", "info");
  summary.errors.forEach(e => {
    const line = [
      e.sheet ? `[${e.sheet}]` : "",
      e.row ? `Zeile ${e.row}` : "",
      e.field ? `Feld "${e.field}"` : "",
      "‚Üí",
      e.message || ""
    ].filter(Boolean).join(" ");
    log("  - " + line, "error-item");
  });
}

async function callApi(endpoint) {
  const file = document.getElementById("file").files[0];
  if (!file) return log("Bitte eine Excel-Datei ausw√§hlen.", "err");

  const excelData = await readFileBase64(file);
  const password = document.getElementById("password").value;
  const allowPriceOverride = document.getElementById("override").checked;

  let data;
  try {
    const res = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ excelData, password, allowPriceOverride })
    });
    data = await res.json();
  } catch {
    return log("‚ùå Serverfehler / Netzwerkfehler", "err");
  }

  if (!data.ok) {
    log(`‚ùå Fehler (${data.status || "UNBEKANNT"}): ${data.message}`, "err");
    logErrors(data?.data?.summary);
    return;
  }

  if (data?.data?.quotationId) {
    log("‚úÖ Angebot erstellt ‚Äî ID: " + data.data.quotationId, "ok");
  } else {
    log("üü¢ Test erfolgreich ‚Äî keine kritischen Fehler.", "ok");
  }
}

// Buttons
document.getElementById("btnTest").onclick  = () => callApi("/api/test-excel");
document.getElementById("btnOffer").onclick = () => callApi("/api/create-offer");

// Template-Download (GitHub-Ordner /templates)
document.getElementById("btnTemplate").onclick = () => {
  window.location.href = "/templates/lexware_template.xlsx";
};

// Systemstatus
fetch("/api/ping")
  .then(r => r.json())
  .then(d =>
    document.getElementById("sys").textContent =
      "Backend erreichbar ‚Äî Rate-Limiter: " +
      d.minIntervalMs +
      " ms ‚Äî Passwort: " +
      (d.passwordProtected ? "aktiv" : "aus")
  )
  .catch(() =>
    document.getElementById("sys").textContent = "‚ùå Backend nicht erreichbar."
  );
</script>

</body>
</html>
