<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Maiershirts ‚Äî Lexoffice Angebots-Tool</title>

<style>
body { font-family: Arial, sans-serif; padding: 24px; }
h2 { margin-bottom: 10px; }

.box {
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 12px;
}

button {
  padding: 8px 12px;
  margin-right: 8px;
  cursor: pointer;
}

button[disabled] { opacity: .6; cursor: not-allowed; }

#log {
  white-space: pre-wrap;
  font-family: monospace;
  max-height: 420px;
  overflow-y: auto;
}

.ok  { color: green; }
.err { color: red; }
.info { color: #444; }

.error-item { margin-left: 10px; font-size: 13px; }
.hr { border-top: 1px dashed #ccc; margin: 8px 0; }
</style>
</head>

<body>

<h2>Maiershirts ‚Äî Lexoffice Angebots-Tool</h2>

<div class="box">
  <button id="btnTemplate">Excel-Template herunterladen</button>
</div>

<div class="box">
  <label>Tool-Passwort:</label><br>
  <input id="password" type="password" />
</div>

<div class="box">
  <label>Excel-Datei (.xlsx):</label><br>
  <input id="file" type="file" accept=".xlsx" />
</div>

<div class="box">
  <label>
    <input id="override" type="checkbox" />
    Artikelpreis √ºberschreiben erlauben
  </label>
</div>

<div class="box">
  <button id="btnTest">Testmodus ausf√ºhren</button>
  <button id="btnOffer">Angebot erstellen</button>
  <button id="btnPdf" disabled>PDF herunterladen</button>
</div>

<div class="box">
  <strong>Systemstatus:</strong><br>
  <div id="sys" class="info">Wird gepr√ºft‚Ä¶</div>
</div>

<div class="box">
  <strong>Protokoll:</strong><br>
  <div id="log"></div>
</div>

<script>
let busy = false;
let lastQuotationId = null;

async function readFileBase64(file) {
  return new Promise(resolve => {
    const r = new FileReader();
    r.onload = () => resolve(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

function log(msg, cls = "") {
  const el = document.getElementById("log");
  const div = document.createElement("div");
  if (cls) div.className = cls;
  div.textContent = msg;
  el.prepend(div);
}

function logLine() {
  const el = document.getElementById("log");
  const div = document.createElement("div");
  div.className = "hr";
  el.prepend(div);
}

function logErrorsFromSummary(summary) {
  if (!summary || !Array.isArray(summary.errors) || !summary.errors.length) return;

  log('Details zu den Fehlern:', 'info');
  summary.errors.forEach(err => {
    const line = [
      err.sheet ? `[${err.sheet}]` : '',
      err.row ? `Zeile ${err.row}` : '',
      err.field ? `Feld "${err.field}"` : '',
      '‚Üí',
      err.message || ''
    ].filter(Boolean).join(' ');
    log('  - ' + line, 'error-item');
  });
}

function logWarningsFromSummary(summary) {
  if (!summary || !Array.isArray(summary.warnings) || !summary.warnings.length) return;

  log('Hinweise / Warnungen:', 'info');
  summary.warnings.forEach(w => {
    const line = [
      w.sheet ? `[${w.sheet}]` : '',
      w.row ? `Zeile ${w.row}` : '',
      '‚Üí',
      w.message || ''
    ].filter(Boolean).join(' ');
    log('  - ' + line, 'error-item');
  });
}

/**
 * Separate Passage: Lexware API
 */
function logLexwareApi(technical) {
  logLine();
  log('‚Äî‚Äî Lexware API ‚Äî‚Äî', 'info');

  if (!technical) {
    log('Keine technical-Daten vorhanden (technical ist leer).', 'err');
    return;
  }

  if (technical.httpStatus) log('HTTP-Status: ' + technical.httpStatus, 'info');

  const meta = technical.meta || {};
  if (meta.requestId) log('requestId: ' + meta.requestId, 'info');
  if (meta.traceId) log('traceId: ' + meta.traceId, 'info');
  if (meta.path) log('path: ' + meta.path, 'info');
  if (meta.timestamp) log('timestamp: ' + meta.timestamp, 'info');
  if (meta.message) log('message: ' + meta.message, 'info');

  if (Array.isArray(meta.details) && meta.details.length) {
    log('details:', 'info');
    meta.details.forEach(d => {
      const line = [
        d.field ? d.field : '',
        d.violation ? `(${d.violation})` : '',
        d.message ? '‚Üí ' + d.message : ''
      ].filter(Boolean).join(' ');
      log('  - ' + line, 'error-item');
    });
  }

  if (technical.raw) {
    try {
      log('raw:\n' + JSON.stringify(technical.raw, null, 2), 'info');
    } catch {
      log('raw: ' + String(technical.raw), 'info');
    }
  }
}

function setBusy(v) {
  busy = v;
  document.getElementById("btnTest").disabled = v;
  document.getElementById("btnOffer").disabled = v;
}

async function callApi(endpoint) {
  const fileInput = document.getElementById("file");
  const password = document.getElementById("password").value;
  const allowPriceOverride = document.getElementById("override").checked;

  if (!fileInput.files[0]) {
    log("Bitte zuerst eine Excel-Datei ausw√§hlen.", "err");
    return;
  }
  if (busy) return;

  setBusy(true);
  try {
    const excelData = await readFileBase64(fileInput.files[0]);

    const res = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ excelData, password, allowPriceOverride })
    });

    const data = await res.json();
    console.log("API Antwort:", data);

    if (!data.ok) {
      const status = data.status || 'UNBEKANNT';
      const msg = data.message || 'Keine genaue Fehlermeldung vorhanden.';
      log(`‚ùå Fehler (${status}): ${msg}`, "err");

      if (data.data && data.data.summary) {
        logErrorsFromSummary(data.data.summary);
        logWarningsFromSummary(data.data.summary);
      }

      logLexwareApi(data.technical || null);
      return;
    }

    if (data.data && data.data.quotationId) {
      lastQuotationId = data.data.quotationId;
      log("‚úÖ Angebot erstellt ‚Äî ID: " + lastQuotationId, "ok");
      document.getElementById("btnPdf").disabled = false;
    } else {
      log("üü¢ Test erfolgreich ‚Äî keine kritischen Fehler. ", "ok");
    }

    if (data.data && data.data.summary) {
      logWarningsFromSummary(data.data.summary);
    }
  } catch (e) {
    console.error(e);
    log("‚ùå Netzwerk- oder Serverfehler beim API-Aufruf.", "err");
  } finally {
    setBusy(false);
  }
}

// Template Download
document.getElementById("btnTemplate").onclick = () => {
  window.location.href = "/templates/lexware_template.xlsx";
};

// Buttons
document.getElementById("btnTest").onclick  = () => callApi("/api/test-excel");
document.getElementById("btnOffer").onclick = () => callApi("/api/create-offer");

// ‚úÖ PDF Download (mit Passwort-Header)
document.getElementById("btnPdf").onclick = async () => {
  if (!lastQuotationId) {
    log("Bitte zuerst ein Angebot erstellen, dann PDF laden.", "err");
    return;
  }

  const password = document.getElementById("password").value;

  try {
    log("PDF wird geladen ‚Ä¶", "info");

    const res = await fetch("/api/download-pdf?id=" + encodeURIComponent(lastQuotationId), {
      method: "GET",
      headers: password ? { "x-tool-password": password } : {}
    });

    // server kann im Fehlerfall JSON liefern
    const ct = (res.headers.get("content-type") || "").toLowerCase();

    if (ct.includes("application/json")) {
      const data = await res.json();
      console.log("PDF API Antwort:", data);

      if (!data.ok) {
        log(`‚ùå Fehler (${data.status || "ERROR"}): ${data.message || "PDF Download fehlgeschlagen"}`, "err");
        logLexwareApi(data.technical || null);
        return;
      }
    }

    // sonst: PDF/Blob
    const blob = await res.blob();

    // Dateiname (falls server Content-Disposition liefert)
    let filename = "angebot.pdf";
    const cd = res.headers.get("content-disposition");
    if (cd && cd.includes("filename=")) {
      const m = cd.match(/filename="?([^"]+)"?/i);
      if (m && m[1]) filename = m[1];
    }

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    log("‚úÖ PDF Download gestartet.", "ok");
  } catch (e) {
    console.error(e);
    log("‚ùå PDF Download fehlgeschlagen (Netzwerk/Browser).", "err");
  }
};

// Ping
fetch("/api/ping")
  .then(r => r.json())
  .then(d => {
    const sys = document.getElementById("sys");
    if (!d.ok) {
      sys.textContent = "Backend antwortet, aber ok=false.";
      return;
    }
    sys.textContent =
      "Backend erreichbar ‚Äî Rate-Limiter: " + (d.minIntervalMs || 0) + " ms ‚Äî Passwort: " +
      (d.passwordProtected ? "aktiv" : "aus");
  })
  .catch(() => {
    document.getElementById("sys").textContent = "‚ùå Backend nicht erreichbar.";
  });
</script>

</body>
</html>
