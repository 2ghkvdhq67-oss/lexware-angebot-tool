<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Maiershirts ‚Äî Lexoffice Angebots-Tool</title>

<style>
body { font-family: Arial, sans-serif; padding: 24px; }
h2 { margin-bottom: 10px; }

.box {
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 12px;
}

button {
  padding: 8px 12px;
  margin-right: 8px;
  cursor: pointer;
}

input[type="text"], input[type="password"] {
  padding: 7px 10px;
  width: 360px;
  max-width: 100%;
}

#log {
  white-space: pre-wrap;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  max-height: 340px;
  overflow-y: auto;
  border: 1px dashed #eee;
  padding: 10px;
  border-radius: 6px;
  background: #fafafa;
}

.ok  { color: #0a7a0a; }
.err { color: #b00020; }
.info { color: #333; }

.line {
  margin: 2px 0;
  font-size: 13px;
}

hr.sep {
  border: none;
  border-top: 1px solid #eee;
  margin: 10px 0;
}
.small { font-size: 12px; color:#666; }
.row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
</style>
</head>

<body>

<h2>Maiershirts ‚Äî Lexoffice Angebots-Tool</h2>

<div class="box">
  <div class="row">
    <div>
      <label>Tool-Passwort:</label><br>
      <input id="password" type="password" placeholder="Passwort (falls aktiviert)" />
      <div class="small">Wird f√ºr API-Aufrufe per Header <code>x-tool-password</code> genutzt.</div>
    </div>
  </div>
</div>

<div class="box">
  <div class="row">
    <button id="btnTemplate">Template herunterladen (automatisch, mit Dropdown)</button>
    <span class="small">zieht Artikel-Lookup automatisch aus Lexware (TTL 10 min)</span>
  </div>
</div>

<div class="box">
  <label>Excel-Datei (.xlsx):</label><br>
  <input id="file" type="file" accept=".xlsx" />
</div>

<div class="box">
  <div class="row">
    <label>
      <input id="override" type="checkbox" />
      Artikelpreis √ºberschreiben erlauben
    </label>
  </div>
</div>

<div class="box">
  <div class="row">
    <button id="btnTest">Testmodus ausf√ºhren</button>
    <button id="btnOffer">Angebot erstellen</button>
    <button id="btnFinalize">Angebot finalisieren</button>
  </div>
</div>

<div class="box">
  <div class="row">
    <div>
      <label>Quotation ID (f√ºr PDF):</label><br>
      <input id="quotationId" type="text" placeholder="wird nach Erstellung automatisch gef√ºllt" />
    </div>
    <div style="align-self:flex-end;">
      <button id="btnPdf">PDF herunterladen</button>
    </div>
  </div>
</div>

<div class="box">
  <strong>Systemstatus:</strong><br>
  <div id="sys" class="info">Wird gepr√ºft‚Ä¶</div>
</div>

<div class="box">
  <strong>Protokoll (chronologisch):</strong><br>
  <div id="log"></div>
</div>

<script>
function ts() {
  const d = new Date();
  return d.toLocaleString();
}

function log(msg, cls = "info") {
  const el = document.getElementById("log");
  const div = document.createElement("div");
  div.className = "line " + (cls || "");
  div.textContent = `[${ts()}] ${msg}`;
  el.appendChild(div);          // ‚úÖ CHRONOLOGISCH
  el.scrollTop = el.scrollHeight;
}

function sep() {
  const el = document.getElementById("log");
  const hr = document.createElement("hr");
  hr.className = "sep";
  el.appendChild(hr);
  el.scrollTop = el.scrollHeight;
}

async function readFileBase64(file) {
  return new Promise(resolve => {
    const r = new FileReader();
    r.onload = () => resolve(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

function getPasswordHeader() {
  const password = document.getElementById("password").value || "";
  return password ? { "x-tool-password": password } : {};
}

function printTechnical(technical) {
  if (!technical) return;

  log("‚Äî‚Äî Lexware API (technical) ‚Äî‚Äî", "info");

  if (technical.httpStatus != null) log("HTTP-Status: " + technical.httpStatus, "info");

  if (technical.meta) {
    const m = technical.meta;
    if (m.message) log("message: " + m.message, "info");
    if (m.timestamp) log("timestamp: " + m.timestamp, "info");
    if (m.path) log("path: " + m.path, "info");
    if (m.traceId) log("traceId: " + m.traceId, "info");
    if (m.requestId) log("requestId: " + m.requestId, "info");
    if (m.details && Array.isArray(m.details)) {
      log("details:", "info");
      m.details.forEach(d => log("  - " + JSON.stringify(d), "info"));
    }
  }

  if (technical.raw) {
    log("raw:", "info");
    try { log(JSON.stringify(technical.raw, null, 2), "info"); }
    catch { log(String(technical.raw), "info"); }
  }
}

function logErrorsFromSummary(summary) {
  if (!summary || !Array.isArray(summary.errors) || !summary.errors.length) return;

  log("Details zu den Fehlern:", "err");
  summary.errors.forEach(err => {
    const line = [
      err.sheet ? `[${err.sheet}]` : '',
      err.row ? `Zeile ${err.row}` : '',
      err.field ? `Feld "${err.field}"` : '',
      '‚Üí',
      err.message || ''
    ].filter(Boolean).join(' ');
    log("  - " + line, "err");
  });
}

function logWarningsFromSummary(summary) {
  if (!summary || !Array.isArray(summary.warnings) || !summary.warnings.length) return;

  log("Hinweise / Warnungen:", "info");
  summary.warnings.forEach(w => {
    const line = [
      w.sheet ? `[${w.sheet}]` : '',
      w.row ? `Zeile ${w.row}` : '',
      w.message || ''
    ].filter(Boolean).join(' ');
    log("  - " + line, "info");
  });
}

async function postExcel(endpoint, extraBody = {}) {
  const fileInput = document.getElementById("file");
  const password = document.getElementById("password").value;
  const allowPriceOverride = document.getElementById("override").checked;

  if (!fileInput.files[0]) {
    log("Bitte zuerst eine Excel-Datei ausw√§hlen.", "err");
    return null;
  }

  const excelData = await readFileBase64(fileInput.files[0]);

  const res = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ excelData, password, allowPriceOverride, ...extraBody })
  });

  return await res.json();
}

async function runTest() {
  sep();
  log("Aktion: /api/test-excel", "info");

  try {
    const data = await postExcel("/api/test-excel");
    if (!data) return;

    if (!data.ok) {
      log(`‚ùå Fehler (${data.status || "UNBEKANNT"}): ${data.message || "Unbekannt"}`, "err");
      if (data.data?.summary) {
        logErrorsFromSummary(data.data.summary);
        logWarningsFromSummary(data.data.summary);
      }
      if (data.technical) printTechnical(data.technical);
      return;
    }

    log("üü¢ " + (data.message || "Test erfolgreich ‚Äî keine kritischen Fehler."), "ok");
    if (data.data?.summary) logWarningsFromSummary(data.data.summary);
  } catch (e) {
    console.error(e);
    log("‚ùå Netzwerk- oder Serverfehler beim Test.", "err");
  }
}

async function runCreate(finalize) {
  sep();
  log("Aktion: /api/create-offer (finalize=" + (finalize ? "true" : "false") + ")", "info");

  try {
    const data = await postExcel("/api/create-offer", { finalize: !!finalize });
    if (!data) return;

    if (!data.ok) {
      log(`‚ùå Fehler (${data.status || "UNBEKANNT"}): ${data.message || "Unbekannt"}`, "err");
      if (data.data?.summary) {
        logErrorsFromSummary(data.data.summary);
        logWarningsFromSummary(data.data.summary);
      }
      if (data.technical) printTechnical(data.technical);
      return;
    }

    const qid = data.data?.quotationId || null;
    log("‚úÖ Angebot erstellt ‚Äî ID: " + (qid || "(keine ID zur√ºckgegeben)"), "ok");
    if (qid) document.getElementById("quotationId").value = qid;

    if (data.data?.summary) logWarningsFromSummary(data.data.summary);
  } catch (e) {
    console.error(e);
    log("‚ùå Netzwerk- oder Serverfehler beim Erstellen.", "err");
  }
}

async function downloadTemplate() {
  sep();
  log("Aktion: Template herunterladen (/api/template.xlsx)", "info");

  try {
    const r = await fetch("/api/template.xlsx", { method: "GET", headers: { ...getPasswordHeader() } });
    const ct = (r.headers.get("content-type") || "").toLowerCase();

    if (ct.includes("application/json")) {
      const j = await r.json();
      log(`‚ùå Template Fehler (${j.status || "ERROR"}): ${j.message || "Unbekannt"}`, "err");
      if (j.technical) printTechnical(j.technical);
      return;
    }

    if (!r.ok) {
      log("‚ùå Template Download fehlgeschlagen (HTTP " + r.status + ").", "err");
      return;
    }

    const blob = await r.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "lexware_template.xlsx";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    log("‚úÖ Template heruntergeladen (Dropdown & Artikel-Lookup automatisch).", "ok");
  } catch (e) {
    console.error(e);
    log("‚ùå Template Download fehlgeschlagen (Netzwerk/Server).", "err");
  }
}

async function downloadPdf() {
  sep();
  const id = (document.getElementById("quotationId").value || "").trim();
  if (!id) {
    log("Bitte Quotation ID eingeben (oder erst Angebot erstellen).", "err");
    return;
  }

  log("Aktion: PDF herunterladen (/api/download-pdf?id=...)", "info");

  try {
    const r = await fetch("/api/download-pdf?id=" + encodeURIComponent(id), {
      method: "GET",
      headers: { ...getPasswordHeader() }
    });

    const ct = (r.headers.get("content-type") || "").toLowerCase();
    if (ct.includes("application/json")) {
      const j = await r.json();
      log(`‚ùå PDF Fehler (${j.status || "ERROR"}): ${j.message || "Unbekannt"}`, "err");
      if (j.technical) printTechnical(j.technical);
      return;
    }

    if (!r.ok) {
      log("‚ùå PDF Download fehlgeschlagen (HTTP " + r.status + ").", "err");
      return;
    }

    const blob = await r.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "quotation.pdf";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    log("‚úÖ PDF heruntergeladen.", "ok");
  } catch (e) {
    console.error(e);
    log("‚ùå PDF Download fehlgeschlagen (Netzwerk/Server).", "err");
  }
}

// Buttons
document.getElementById("btnTemplate").onclick = () => downloadTemplate();
document.getElementById("btnTest").onclick = () => runTest();
document.getElementById("btnOffer").onclick = () => runCreate(false);
document.getElementById("btnFinalize").onclick = () => runCreate(true);
document.getElementById("btnPdf").onclick = () => downloadPdf();

// Systemstatus
fetch("/api/ping")
  .then(r => r.json())
  .then(d => {
    const sys = document.getElementById("sys");
    if (!d.ok) {
      sys.textContent = "Backend antwortet, aber ok=false.";
      return;
    }
    sys.textContent =
      "Backend erreichbar ‚Äî Rate-Limiter: " + d.minIntervalMs + " ms ‚Äî Passwort: " +
      (d.passwordProtected ? "aktiv" : "aus") +
      " ‚Äî Template TTL: " + (d.templateTtlMs ? Math.round(d.templateTtlMs/60000) + " min" : "?");
  })
  .catch(() => {
    document.getElementById("sys").textContent = "‚ùå Backend nicht erreichbar.";
  });
</script>

</body>
</html>
