<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Maiershirts ‚Äî Lexoffice Angebots-Tool</title>
<style>
  body { font-family: Arial, sans-serif; padding: 24px; }
  h2 { margin-bottom: 10px; }
  .box { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: #fff; }
  label { font-weight: 600; }
  input[type="password"], input[type="file"], input[type="text"] { margin-top: 6px; }
  button { padding: 8px 12px; margin-right: 8px; cursor: pointer; border: 1px solid #ccc; border-radius: 8px; background: #f6f6f6; }
  button.secondary { opacity: 0.92; }
  button.primary { background: #111; color: #fff; border-color: #111; }
  button.danger { background: #fff; border-color: #d0d0d0; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  .muted { color: #666; font-size: 12px; margin-top: 6px; line-height: 1.35; }
  .row { display: flex; gap: 14px; flex-wrap: wrap; align-items: center; }
  .col { display: flex; flex-direction: column; gap: 10px; }
  #log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; max-height: 360px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; background: #fafafa; }
  .ok { color: #0a7a2f; } .err { color: #b00020; } .info { color: #333; } .warn { color: #8a5a00; }
  .pill { display: inline-flex; align-items: center; gap: 8px; border: 1px solid #ddd; border-radius: 999px; padding: 6px 10px; background: #fff; }
  .statusline { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; font-size: 12px; }
  .badge { display: inline-flex; align-items: center; gap: 6px; border: 1px solid #ddd; border-radius: 999px; padding: 6px 10px; background: #fff; }
  .dot { width: 8px; height: 8px; border-radius: 99px; display: inline-block; background: #bbb; }
  .dot.ok { background: #0a7a2f; } .dot.err { background: #b00020; } .dot.warn { background: #8a5a00; }
  .split { display: grid; grid-template-columns: 1fr; gap: 12px; }
  @media (min-width: 980px) { .split { grid-template-columns: 1.15fr 0.85fr; } }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .small { font-size: 12px; }
  .inline-input { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .inputbox { border: 1px solid #ddd; border-radius: 8px; padding: 8px 10px; background: #fff; min-width: 280px; }
</style>
</head>
<body>

<h2>Maiershirts ‚Äî Lexoffice Angebots-Tool</h2>

<div class="split">
  <div class="col">

    <!-- Passwort -->
    <div class="box">
      <label>Tool-Passwort</label><br>
      <input id="password" type="password" style="width:320px;" autocomplete="current-password" />
      <div class="muted">Wird f√ºr API-Aufrufe und Downloads verwendet.</div>
    </div>

    <!-- Excel -->
    <div class="box">
      <label>Excel-Datei (.xlsx)</label><br>
      <input id="file" type="file" accept=".xlsx" />
      <div id="fileInfo" class="muted">Noch keine Datei ausgew√§hlt.</div>
    </div>

    <!-- Optionen -->
    <div class="box">
      <div class="row">
        <label class="pill"><input type="radio" name="mode" id="modeFinal" value="final" checked /> Final (fertig)</label>
        <label class="pill"><input type="radio" name="mode" id="modeDraft" value="draft" /> Entwurf</label>
        <label class="pill" title="Wenn aktiv, darf Excel-Preis auch bei Artikelpositionen verwendet werden (falls Backend konfiguriert).">
          <input id="override" type="checkbox" /> Artikelpreis √ºberschreiben erlauben
        </label>
      </div>

      <div id="draftHint" class="muted" style="margin-top:8px; display:none;">
        ‚ö†Ô∏è Entwurf gew√§hlt: <b>PDF-Download ist bei Entwurf nicht m√∂glich</b> (Lexware liefert 409).  
        Wenn du PDF brauchst, bitte im Modus <b>Final</b> erstellen.
      </div>

      <div class="muted">
        Hinweis: <b>Ein Entwurf kann per API nicht nachtr√§glich ‚Äûfinalisiert‚Äú werden.</b>
        Wenn du nach einem Entwurf sp√§ter ‚ÄûFinal‚Äú erstellst, entsteht ein <b>neues Angebot</b> mit <b>neuer Angebotsnummer</b>.
      </div>
    </div>

    <!-- Aktionen -->
    <div class="box">
      <div class="row">
        <button id="btnTest">Testmodus ausf√ºhren</button>
        <button id="btnCreate" class="primary">Angebot erstellen</button>
        <button id="btnPdf" disabled>PDF herunterladen</button>
        <button id="btnOpenLexware" disabled>In Lexware √∂ffnen</button>
        <button id="btnReset" class="danger">Neue Sitzung / Reset</button>
      </div>

      <div class="sep" style="height:1px;background:#eee;margin:12px 0;"></div>

      <div class="inline-input">
        <div>
          <div class="small muted">Letztes Angebot</div>
          <input id="lastOfferId" class="inputbox mono" type="text" readonly placeholder="Noch kein Angebot erstellt" />
        </div>
        <button id="btnCopyId" class="secondary" disabled>Copy</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        ‚ÄûIn Lexware √∂ffnen‚Äú klappt nur, wenn du im Browser bei Lexware eingeloggt bist.
      </div>

      <div id="busyHint" class="muted" style="margin-top:10px; display:none;">
        ‚è≥ Bitte warten‚Ä¶ Anfrage l√§uft. Buttons sind kurz deaktiviert.
      </div>
    </div>

    <!-- ‚úÖ TEMPLATE BEREICH GANZ NACH UNTEN -->
    <div class="box">
      <strong>Template</strong>
      <div class="row" style="margin-top:10px;">
        <button id="btnTemplateAuto" class="secondary">Template herunterladen (Auto / TTL)</button>
        <button id="btnTemplateStatic" class="secondary">Template herunterladen (statisch)</button>
        <button id="btnRefreshArticles" class="secondary">Artikel-Cache aktualisieren</button>
      </div>
      <div class="muted">
        Auto = Template inkl. Artikel-Lookup aus Lexware (Cache/TTL).  
        Statisch = Datei aus <span class="mono">/templates</span>.  
        Wenn ein neuer Artikel nicht gefunden wird: ‚ÄûArtikel-Cache aktualisieren‚Äú, dann ggf. Auto-Template neu laden.
      </div>
    </div>

  </div>

  <div class="col">
    <div class="box">
      <strong>Systemstatus</strong>
      <div class="statusline" style="margin-top:10px;">
        <span class="badge"><span id="dotBackend" class="dot"></span><span id="sBackend">Backend: pr√ºfe‚Ä¶</span></span>
        <span class="badge"><span id="dotAuth" class="dot"></span><span id="sAuth">Passwortschutz: ?</span></span>
        <span class="badge"><span id="dotTtl" class="dot"></span><span id="sTtl">Template TTL: ?</span></span>
        <span class="badge"><span id="dotRate" class="dot"></span><span id="sRate">Rate-Limit Puffer: ?</span></span>
      </div>
      <div id="sysDetails" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="box">
      <strong>Protokoll (chronologisch)</strong><br>
      <div id="log" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<script>
let lastOfferId = null;
let pingInfo = null;
let busy = false;

function lexwareOfferUrl(id) {
  return `https://app.lexware.de/voucher/#/${encodeURIComponent(id)}`;
}

function nowTime() {
  const d = new Date();
  return d.toLocaleString();
}

function logLine(msg, cls = "info") {
  const el = document.getElementById("log");
  const div = document.createElement("div");
  div.className = cls || "";
  div.textContent = `[${nowTime()}] ${msg}`;
  el.appendChild(div);
  el.scrollTop = el.scrollHeight;
}

function logJson(title, obj, cls="info") {
  logLine(title, cls);
  try { logLine(JSON.stringify(obj, null, 2), cls); }
  catch { logLine(String(obj), cls); }
}

function setBusy(on) {
  busy = on;
  const disable = !!on;

  document.getElementById("btnTest").disabled = disable;
  document.getElementById("btnCreate").disabled = disable;
  document.getElementById("btnTemplateAuto").disabled = disable;
  document.getElementById("btnTemplateStatic").disabled = disable;
  document.getElementById("btnRefreshArticles").disabled = disable;
  document.getElementById("btnReset").disabled = disable;

  document.getElementById("file").disabled = disable;
  document.getElementById("password").disabled = disable;
  document.getElementById("override").disabled = disable;
  document.getElementById("modeFinal").disabled = disable;
  document.getElementById("modeDraft").disabled = disable;

  document.getElementById("busyHint").style.display = disable ? "block" : "none";
}

function isDraftMode() {
  return document.getElementById("modeDraft").checked;
}
function getFinalizeBoolFromMode() {
  return document.getElementById("modeFinal").checked; // final => true
}

function updateDraftUi() {
  const hint = document.getElementById("draftHint");
  hint.style.display = isDraftMode() ? "block" : "none";

  // wenn Draft aktiv: PDF deaktivieren (auch wenn es eine ID gibt)
  const btnPdf = document.getElementById("btnPdf");
  if (isDraftMode()) btnPdf.disabled = true;
  else btnPdf.disabled = !lastOfferId;
}

function updateLastOfferUi() {
  const input = document.getElementById("lastOfferId");
  const btnCopy = document.getElementById("btnCopyId");
  const btnPdf = document.getElementById("btnPdf");
  const btnOpen = document.getElementById("btnOpenLexware");

  if (lastOfferId) {
    input.value = lastOfferId;
    btnCopy.disabled = false;
    btnOpen.disabled = false;
    btnPdf.disabled = isDraftMode(); // Draft => disabled
  } else {
    input.value = "";
    btnCopy.disabled = true;
    btnPdf.disabled = true;
    btnOpen.disabled = true;
  }
}

function validateBeforeAction({ needsExcel=true, needsPasswordMaybe=true } = {}) {
  if (needsExcel) {
    const fileInput = document.getElementById("file");
    if (!fileInput.files || !fileInput.files[0]) {
      logLine("‚ùå Bitte zuerst eine Excel-Datei ausw√§hlen.", "err");
      return false;
    }
  }

  if (needsPasswordMaybe && pingInfo && pingInfo.passwordProtected) {
    const pw = document.getElementById("password").value;
    if (!pw) {
      logLine("‚ùå Passwortschutz ist aktiv: Bitte Tool-Passwort eingeben.", "err");
      return false;
    }
  }
  return true;
}

async function readFileBase64(file) {
  return new Promise(resolve => {
    const r = new FileReader();
    r.onload = () => resolve(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

function logErrorsFromSummary(summary) {
  if (!summary || !Array.isArray(summary.errors) || !summary.errors.length) return;
  logLine("Details zu den Fehlern:", "info");
  summary.errors.forEach(err => {
    const line = [
      err.sheet ? `[${err.sheet}]` : '',
      err.row ? `Zeile ${err.row}` : '',
      err.field ? `Feld "${err.field}"` : '',
      "‚Üí",
      err.message || ''
    ].filter(Boolean).join(" ");
    logLine("  - " + line, "err");
  });
}

function logWarningsFromSummary(summary) {
  if (!summary || !Array.isArray(summary.warnings) || !summary.warnings.length) return;
  logLine("Hinweise / Warnungen:", "warn");
  summary.warnings.forEach(w => {
    const line = [
      w.sheet ? `[${w.sheet}]` : '',
      w.row ? `Zeile ${w.row}` : '',
      "‚Üí",
      w.message || ''
    ].filter(Boolean).join(" ");
    logLine("  - " + line, "warn");
  });
}

function getAuthHeaders() {
  const password = document.getElementById("password").value;
  const headers = {};
  if (password) headers["x-tool-password"] = password;
  return headers;
}

async function callApi(endpoint, extraBody = {}) {
  const fileInput = document.getElementById("file");
  const password = document.getElementById("password").value;
  const allowPriceOverride = document.getElementById("override").checked;

  const file = fileInput.files[0];
  const excelData = await readFileBase64(file);

  let data;
  try {
    const res = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...getAuthHeaders() },
      body: JSON.stringify({ excelData, password, allowPriceOverride, ...extraBody })
    });
    data = await res.json();
  } catch (e) {
    console.error(e);
    logLine("‚ùå Netzwerk- oder Serverfehler beim API-Aufruf.", "err");
    return null;
  }

  if (!data.ok) {
    logLine(`‚ùå Fehler (${data.status || "UNBEKANNT"}): ${data.message || "Keine genaue Fehlermeldung vorhanden."}`, "err");

    // ‚úÖ PDF-Draft Spezialfall verst√§ndlich machen
    if (data.stage === "lexware-pdf" && data.technical && data.technical.httpStatus === 409) {
      logLine("‚û°Ô∏è PDF ist nur bei FINAL-Angeboten m√∂glich. Dieses Angebot ist im Status ENTWURF.", "warn");
      logLine("‚û°Ô∏è L√∂sung: Angebot im Modus ‚ÄûFinal‚Äú erstellen (Entwurf kann per API nicht nachtr√§glich finalisiert werden).", "warn");
    }

    if (data.technical) logJson("‚Äî‚Äî Technical (Lexware/Lexoffice API) ‚Äî‚Äî", data.technical, "info");
    if (data.data && data.data.summary) {
      logErrorsFromSummary(data.data.summary);
      logWarningsFromSummary(data.data.summary);
    }
    return data;
  }

  if (data.data && data.data.quotationId) {
    lastOfferId = data.data.quotationId;
    updateLastOfferUi();
    logLine(`‚úÖ Angebot erstellt ‚Äî Angebots-ID: ${lastOfferId}`, "ok");
    if (isDraftMode()) logLine("‚ÑπÔ∏è Entwurf erstellt: PDF ist hier nicht m√∂glich (nur Final).", "info");
  } else {
    logLine("üü¢ Test erfolgreich ‚Äî keine kritischen Fehler.", "ok");
  }

  if (data.data && data.data.summary) {
    logWarningsFromSummary(data.data.summary);
  }

  return data;
}

// Events: Mode change
document.getElementById("modeFinal").addEventListener("change", () => { updateDraftUi(); updateLastOfferUi(); });
document.getElementById("modeDraft").addEventListener("change", () => { updateDraftUi(); updateLastOfferUi(); });

document.getElementById("btnTest").onclick = async () => {
  if (busy) return;
  if (!validateBeforeAction({ needsExcel:true, needsPasswordMaybe:true })) return;

  setBusy(true);
  try {
    logLine("Starte Testmodus‚Ä¶", "info");
    await callApi("/api/test-excel");
  } finally {
    setBusy(false);
  }
};

document.getElementById("btnCreate").onclick = async () => {
  if (busy) return;
  if (!validateBeforeAction({ needsExcel:true, needsPasswordMaybe:true })) return;

  const finalize = getFinalizeBoolFromMode();

  setBusy(true);
  try {
    logLine(`Erstelle Angebot im Modus: ${finalize ? "FINAL" : "ENTWURF"} (finalize=${finalize})‚Ä¶`, "info");
    await callApi("/api/create-offer", { finalize });
  } finally {
    setBusy(false);
  }
};

document.getElementById("btnTemplateAuto").onclick = () => {
  if (busy) return;
  if (!validateBeforeAction({ needsExcel:false, needsPasswordMaybe:true })) return;

  const pw = document.getElementById("password").value;
  const url = pw ? `/api/template.xlsx?password=${encodeURIComponent(pw)}` : `/api/template.xlsx`;
  logLine("Lade Template (Auto/TTL)‚Ä¶", "info");
  window.location.href = url;
};

document.getElementById("btnTemplateStatic").onclick = () => {
  if (busy) return;
  logLine("Lade Template (statisch)‚Ä¶", "info");
  window.location.href = `/templates/lexware_template.xlsx`;
};

document.getElementById("btnRefreshArticles").onclick = async () => {
  if (busy) return;
  if (!validateBeforeAction({ needsExcel:false, needsPasswordMaybe:true })) return;

  setBusy(true);
  try {
    logLine("Aktualisiere Artikel-Cache (refresh=1)‚Ä¶", "info");
    const res = await fetch("/api/articles?refresh=1", { headers: { ...getAuthHeaders() } });
    const data = await res.json();
    if (!data.ok) {
      logLine(`‚ùå Fehler (${data.status || "UNBEKANNT"}): ${data.message || "Artikel-Refresh fehlgeschlagen."}`, "err");
      if (data.technical) logJson("‚Äî‚Äî Technical ‚Äî‚Äî", data.technical, "info");
      return;
    }
    const count = data.data?.count ?? "?";
    logLine(`‚úÖ Artikel-Cache aktualisiert. Artikel gefunden: ${count}`, "ok");
    logLine("Tipp: Wenn Dropdown/Template veraltet ist, Template (Auto/TTL) erneut laden.", "info");
  } catch {
    logLine("‚ùå Fehler beim Aktualisieren des Artikel-Caches.", "err");
  } finally {
    setBusy(false);
  }
};

document.getElementById("btnPdf").onclick = () => {
  if (!lastOfferId) { logLine("Keine Angebots-ID vorhanden. Bitte zuerst ein Angebot erstellen.", "err"); return; }
  if (isDraftMode()) {
    logLine("‚ùå PDF ist bei ENTWURF nicht m√∂glich. Bitte im Modus FINAL erstellen.", "err");
    return;
  }
  if (!validateBeforeAction({ needsExcel:false, needsPasswordMaybe:true })) return;

  const pw = document.getElementById("password").value;
  const url = pw
    ? `/api/download-pdf?id=${encodeURIComponent(lastOfferId)}&password=${encodeURIComponent(pw)}`
    : `/api/download-pdf?id=${encodeURIComponent(lastOfferId)}`;

  logLine("Lade PDF‚Ä¶", "info");
  window.location.href = url;
};

document.getElementById("btnOpenLexware").onclick = () => {
  if (!lastOfferId) { logLine("Keine Angebots-ID vorhanden. Bitte zuerst ein Angebot erstellen.", "err"); return; }
  const url = lexwareOfferUrl(lastOfferId);
  logLine("√ñffne Angebot in Lexware (neuer Tab)‚Ä¶", "info");
  window.open(url, "_blank", "noopener,noreferrer");
};

document.getElementById("btnCopyId").onclick = async () => {
  if (!lastOfferId) return;
  try {
    await navigator.clipboard.writeText(lastOfferId);
    logLine("‚úÖ Angebots-ID in die Zwischenablage kopiert.", "ok");
  } catch {
    const input = document.getElementById("lastOfferId");
    input.focus(); input.select();
    document.execCommand("copy");
    logLine("‚úÖ Angebots-ID in die Zwischenablage kopiert (Fallback).", "ok");
  }
};

document.getElementById("btnReset").onclick = () => {
  if (busy) return;
  document.getElementById("log").innerHTML = "";
  lastOfferId = null;
  updateLastOfferUi();

  document.getElementById("modeFinal").checked = true;
  document.getElementById("override").checked = false;

  const fileInput = document.getElementById("file");
  fileInput.value = "";
  document.getElementById("fileInfo").textContent = "Noch keine Datei ausgew√§hlt.";

  updateDraftUi();
  logLine("üîÑ Neue Sitzung gestartet: Protokoll, Datei und letzte Angebots-ID wurden zur√ºckgesetzt.", "ok");
};

document.getElementById("file").addEventListener("change", () => {
  const fileInput = document.getElementById("file");
  const info = document.getElementById("fileInfo");
  if (!fileInput.files || !fileInput.files[0]) {
    info.textContent = "Noch keine Datei ausgew√§hlt.";
    return;
  }
  const f = fileInput.files[0];
  const sizeKb = Math.round((f.size || 0) / 1024);
  info.textContent = `Ausgew√§hlt: ${f.name} (${sizeKb} KB)`;
  logLine(`Excel ausgew√§hlt: ${f.name} (${sizeKb} KB)`, "info");
});

function setStatus(dotId, textId, state, text) {
  const dot = document.getElementById(dotId);
  const lbl = document.getElementById(textId);
  dot.classList.remove("ok","err","warn");
  if (state) dot.classList.add(state);
  lbl.textContent = text;
}

async function refreshPing() {
  try {
    const r = await fetch("/api/ping", { headers: { ...getAuthHeaders() } });
    const d = await r.json();
    pingInfo = d;

    if (!d.ok) { setStatus("dotBackend","sBackend","warn","Backend: antwortet (ok=false)"); return; }

    setStatus("dotBackend","sBackend","ok","Backend: OK");
    if (d.passwordProtected) setStatus("dotAuth","sAuth","warn",`Passwortschutz: aktiv (${d.passwordMode || "?"})`);
    else setStatus("dotAuth","sAuth","ok","Passwortschutz: aus");

    const ttlMin = Math.round((d.templateTtlMs || 0) / 60000);
    setStatus("dotTtl","sTtl","ok",`Template TTL: ${ttlMin} min`);
    setStatus("dotRate","sRate","ok",`Rate-Limit Puffer: ${d.minIntervalMs} ms`);

    document.getElementById("sysDetails").textContent =
      `API: ${d.apiBaseUrl} ‚Ä¢ Finalize-Default: ${d.finalizeDefault ? "true" : "false"} ‚Ä¢ allowPriceOverrideDefault: ${d.allowPriceOverrideDefault ? "true" : "false"}`;

  } catch {
    setStatus("dotBackend","sBackend","err","Backend: nicht erreichbar");
    setStatus("dotAuth","sAuth","","Passwortschutz: ?");
    setStatus("dotTtl","sTtl","","Template TTL: ?");
    setStatus("dotRate","sRate","","Rate-Limit Puffer: ?");
    document.getElementById("sysDetails").textContent = "‚ùå Backend nicht erreichbar.";
  }
}

updateLastOfferUi();
updateDraftUi();
refreshPing();
setInterval(refreshPing, 30000);
</script>

</body>
</html>
