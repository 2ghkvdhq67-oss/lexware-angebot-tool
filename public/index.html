<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Maiershirts — Lexware Angebots-Tool</title>

<style>
  :root {
    --bg: #0b0f14;
    --card: #121826;
    --muted: #9aa4b2;
    --text: #e5e7eb;
    --ok: #22c55e;
    --err: #ef4444;
    --warn: #f59e0b;
    --border: rgba(255,255,255,0.08);
    --btn: #1f2937;
  }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: linear-gradient(180deg, #070a0f, #0b0f14);
    color: var(--text);
  }

  .wrap {
    max-width: 980px;
    margin: 0 auto;
    padding: 22px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  h1 {
    margin: 0 0 6px 0;
    font-size: 20px;
    letter-spacing: 0.2px;
  }

  .sub {
    color: var(--muted);
    font-size: 13px;
    margin-top: -2px;
  }

  .card {
    background: rgba(18, 24, 38, 0.85);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    box-shadow: 0 10px 24px rgba(0,0,0,0.25);
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  @media (max-width: 820px) {
    .grid { grid-template-columns: 1fr; }
  }

  label { display:block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
  input[type="password"], input[type="file"] {
    width: 100%;
    box-sizing: border-box;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.25);
    color: var(--text);
  }

  .row {
    display:flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }

  button {
    background: var(--btn);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 12px;
    cursor: pointer;
    font-weight: 600;
  }
  button:hover { filter: brightness(1.1); }
  button:disabled { opacity: 0.55; cursor: not-allowed; }

  .pill {
    display:inline-block;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid var(--border);
    color: var(--muted);
  }

  .ok { color: var(--ok); }
  .err { color: var(--err); }
  .warn { color: var(--warn); }
  .muted { color: var(--muted); }

  .overview {
    display:grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 10px;
  }
  @media (max-width: 820px) {
    .overview { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  .kpi {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px;
    background: rgba(0,0,0,0.18);
  }
  .kpi .k { font-size: 12px; color: var(--muted); }
  .kpi .v { font-size: 18px; font-weight: 700; margin-top: 4px; }

  #log {
    height: 42vh;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size: 12.5px;
    line-height: 1.4;
    background: rgba(0,0,0,0.25);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
  }

  .logline { margin: 2px 0; }
  .logline.ok { color: var(--ok); }
  .logline.err { color: var(--err); }
  .logline.warn { color: var(--warn); }
  .logline.info { color: var(--text); opacity: 0.92; }
</style>
</head>

<body>
  <div class="wrap">
    <div>
      <h1>Maiershirts — Lexware Angebots-Tool</h1>
      <div class="sub">Phase 1: Stabil & einfach • Testen → Erstellen → (optional) PDF</div>
    </div>

    <div class="grid">
      <div class="card">
        <label>Tool-Passwort</label>
        <input id="password" type="password" placeholder="Passwort eingeben…" />
        <div style="margin-top:10px" class="row">
          <span class="pill" id="sys">Systemstatus: wird geprüft…</span>
          <span class="pill" id="mode">Modus: wird geladen…</span>
        </div>
      </div>

      <div class="card">
        <label>Excel-Datei (.xlsx)</label>
        <input id="file" type="file" accept=".xlsx" />
        <div style="margin-top:10px" class="row">
          <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text)">
            <input id="override" type="checkbox" />
            Artikelpreis überschreiben erlauben
          </label>
          <label style="display:flex; gap:10px; align-items:center; margin:0; color:var(--text)">
            <input id="finalize" type="checkbox" />
            Direkt FINAL erstellen (finalize=true)
          </label>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnTest">Testmodus ausführen</button>
        <button id="btnCreate">Angebot erstellen</button>
        <button id="btnPdf" disabled>PDF herunterladen</button>
        <button id="btnClear" style="margin-left:auto">Protokoll leeren</button>
      </div>
      <div class="muted" style="margin-top:10px; font-size: 13px">
        Tipp: Wenn du <b>PDF</b> willst, nutze <b>FINAL</b> (Entwurf/Draft liefert oft 409).
      </div>

      <div style="margin-top:12px" class="overview">
        <div class="kpi"><div class="k">Status</div><div class="v" id="kStatus">–</div></div>
        <div class="kpi"><div class="k">Errors</div><div class="v" id="kErr">0</div></div>
        <div class="kpi"><div class="k">Warnings</div><div class="v" id="kWarn">0</div></div>
        <div class="kpi"><div class="k">Auto-Namen</div><div class="v" id="kAuto">0</div></div>
      </div>

      <div class="muted" style="margin-top:12px; font-size: 13px" id="lastLinks"></div>
    </div>

    <!-- TEMPLATE (ganz unten wie gewünscht) -->
    <div class="card">
      <div class="row">
        <div style="font-weight:700">Template</div>
        <span class="muted" style="font-size:13px">Statisch aus Repo oder dynamisch (inkl. Artikel-Lookup, Cache/TTL)</span>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnTplStatic">Template (statisch) herunterladen</button>
        <button id="btnTplDynamic">Template (dynamisch) herunterladen</button>
        <button id="btnRefreshArticles" style="margin-left:auto">Artikel-Cache refresh</button>
      </div>
      <div class="muted" style="margin-top:8px; font-size: 13px">
        Hinweis: Wenn Excel wieder <b>#NAME?</b> in articleId schreibt, ist das egal – der Server mappt automatisch über <b>articleNumber</b> oder <b>articleTitle</b>.
      </div>
    </div>

    <!-- PROTOKOLL ganz unten -->
    <div class="card">
      <div class="row">
        <div style="font-weight:700">Protokoll</div>
        <span class="muted" style="font-size:13px">chronologisch • neueste Einträge unten</span>
      </div>
      <div id="log" style="margin-top:10px"></div>
    </div>
  </div>

<script>
  let lastQuotationId = null;

  function ts() {
    const d = new Date();
    return `[${d.toLocaleString('de-DE')}]`;
  }

  function log(msg, cls = "info") {
    const el = document.getElementById("log");
    const div = document.createElement("div");
    div.className = `logline ${cls}`;
    div.textContent = `${ts()} ${msg}`;
    el.appendChild(div);                 // ✅ chronologisch
    el.scrollTop = el.scrollHeight;      // ✅ nicht abgeschnitten: autoscroll
  }

  function clearLog() {
    document.getElementById("log").innerHTML = "";
  }

  async function readFileBase64(file) {
    return new Promise(resolve => {
      const r = new FileReader();
      r.onload = () => resolve(r.result.split(",")[1]);
      r.readAsDataURL(file);
    });
  }

  function setKpis({ statusText = "–", err = 0, warn = 0, auto = 0 } = {}) {
    document.getElementById("kStatus").textContent = statusText;
    document.getElementById("kErr").textContent = String(err);
    document.getElementById("kWarn").textContent = String(warn);
    document.getElementById("kAuto").textContent = String(auto);
  }

  function renderLinks(quotationId) {
    const el = document.getElementById("lastLinks");
    if (!quotationId) { el.textContent = ""; return; }
    const editUrl = `https://app.lexware.de/voucher/#/${quotationId}`;
    el.innerHTML = `Letztes Angebot: <span class="pill">${quotationId}</span> • <a href="${editUrl}" target="_blank" rel="noopener noreferrer">In Lexware öffnen</a>`;
  }

  function logErrorsFromSummary(summary) {
    if (!summary || !Array.isArray(summary.errors) || !summary.errors.length) return;
    log("Details zu den Fehlern:", "err");
    summary.errors.forEach(err => {
      const line = [
        err.sheet ? `[${err.sheet}]` : '',
        err.row ? `Zeile ${err.row}` : '',
        err.field ? `Feld "${err.field}"` : '',
        '→',
        err.message || ''
      ].filter(Boolean).join(' ');
      log('  - ' + line, 'err');
    });
  }

  function logWarningsFromSummary(summary) {
    if (!summary || !Array.isArray(summary.warnings) || !summary.warnings.length) return;
    log("Hinweise / Warnungen:", "warn");
    summary.warnings.forEach(w => {
      const line = [
        w.sheet ? `[${w.sheet}]` : '',
        w.row ? `Zeile ${w.row}` : '',
        '→',
        w.message || ''
      ].filter(Boolean).join(' ');
      log('  - ' + line, 'warn');
    });
  }

  function updateOverviewFromSummary(summary, statusText) {
    const err = summary?.errors?.length || 0;
    const warn = summary?.warnings?.length || 0;
    const auto = summary?.autoNamedLineItems?.length || 0;
    setKpis({ statusText, err, warn, auto });
  }

  async function callApi(endpoint, extraBody = {}) {
    const fileInput = document.getElementById("file");
    const password = document.getElementById("password").value;
    const allowPriceOverride = document.getElementById("override").checked;
    const finalize = document.getElementById("finalize").checked;

    if (!fileInput.files[0]) {
      log("Bitte zuerst eine Excel-Datei auswählen.", "err");
      return null;
    }

    const excelData = await readFileBase64(fileInput.files[0]);

    const body = {
      excelData,
      password,
      allowPriceOverride,
      finalize,
      ...extraBody
    };

    let data;
    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      data = await res.json();
    } catch (e) {
      console.error(e);
      log("❌ Netzwerk- oder Serverfehler beim API-Aufruf.", "err");
      return null;
    }

    // Debug in Console
    console.log("API Antwort:", data);

    if (!data.ok) {
      const status = data.status || 'UNBEKANNT';
      const msg = data.message || 'Keine genaue Fehlermeldung vorhanden.';
      log(`❌ Fehler (${status}): ${msg}`, "err");

      // Lexware Technical block klar anzeigen
      if (data.technical) {
        log("—— Lexware API ——", "muted");
        if (data.technical.httpStatus != null) log(`HTTP-Status: ${data.technical.httpStatus}`, "muted");
        if (data.technical.meta?.message) log(`message: ${data.technical.meta.message}`, "muted");
        if (data.technical.meta?.traceId) log(`traceId: ${data.technical.meta.traceId}`, "muted");
        if (data.technical.meta?.requestId) log(`requestId: ${data.technical.meta.requestId}`, "muted");
        if (data.technical.raw) {
          log("raw:", "muted");
          log(JSON.stringify(data.technical.raw, null, 2), "muted");
        }
      }

      if (data.data && data.data.summary) {
        updateOverviewFromSummary(data.data.summary, "FEHLER");
        logErrorsFromSummary(data.data.summary);
        logWarningsFromSummary(data.data.summary);
      } else {
        setKpis({ statusText: "FEHLER" });
      }

      return data;
    }

    // Erfolgsfall
    const msg = data.message || "OK";
    log(`✅ ${msg}`, "ok");

    if (data.data && data.data.quotationId) {
      lastQuotationId = data.data.quotationId;
      renderLinks(lastQuotationId);
      document.getElementById("btnPdf").disabled = false;
      log(`Angebot-ID: ${lastQuotationId}`, "ok");
    }

    if (data.data && data.data.summary) {
      updateOverviewFromSummary(data.data.summary, "OK");
      logWarningsFromSummary(data.data.summary);
    } else {
      setKpis({ statusText: "OK" });
    }

    return data;
  }

  // Buttons
  document.getElementById("btnTest").onclick = async () => {
    log("Starte Testmodus…", "info");
    await callApi("/api/test-excel");
  };

  document.getElementById("btnCreate").onclick = async () => {
    const finalize = document.getElementById("finalize").checked;
    log(`Erstelle Angebot im Modus: ${finalize ? "FINAL" : "ENTWURF"} (finalize=${finalize})…`, "info");
    await callApi("/api/create-offer");
  };

  document.getElementById("btnPdf").onclick = async () => {
    const password = document.getElementById("password").value;
    if (!lastQuotationId) {
      log("Kein Angebot vorhanden. Bitte erst erstellen.", "err");
      return;
    }

    // PDF Download ist GET -> Passwort per Query
    const url = `/api/download-pdf?id=${encodeURIComponent(lastQuotationId)}&password=${encodeURIComponent(password)}`;
    log("Starte PDF Download…", "info");

    try {
      const res = await fetch(url);
      const contentType = res.headers.get("content-type") || "";

      if (contentType.includes("application/json")) {
        const j = await res.json();
        console.log("PDF JSON:", j);
        log(`❌ PDF Fehler (${j.status || "ERROR"}): ${j.message || "Unbekannt"}`, "err");
        if (j.technical?.raw) log(JSON.stringify(j.technical.raw, null, 2), "muted");
        return;
      }

      const blob = await res.blob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `quotation_${lastQuotationId}.pdf`;
      a.click();
      URL.revokeObjectURL(a.href);
      log("✅ PDF Download gestartet.", "ok");
    } catch (e) {
      console.error(e);
      log("❌ Fehler beim PDF Download.", "err");
    }
  };

  document.getElementById("btnClear").onclick = () => {
    clearLog();
    setKpis({ statusText: "–", err: 0, warn: 0, auto: 0 });
    document.getElementById("lastLinks").textContent = "";
    log("Protokoll geleert.", "muted");
  };

  document.getElementById("btnTplStatic").onclick = () => {
    window.open("/templates/lexware_template.xlsx", "_blank");
    log("Template (statisch) geöffnet.", "info");
  };

  document.getElementById("btnTplDynamic").onclick = () => {
    const password = document.getElementById("password").value;
    window.open(`/api/template.xlsx?password=${encodeURIComponent(password)}`, "_blank");
    log("Template (dynamisch) angefordert.", "info");
  };

  document.getElementById("btnRefreshArticles").onclick = async () => {
    const password = document.getElementById("password").value;
    log("Artikel-Cache refresh…", "info");
    try {
      const res = await fetch(`/api/articles?refresh=1&password=${encodeURIComponent(password)}`);
      const j = await res.json();
      if (!j.ok) {
        log(`❌ Refresh Fehler: ${j.message || "Unbekannt"}`, "err");
        return;
      }
      log(`✅ Artikel neu geladen: ${j.data?.count || 0}`, "ok");
    } catch (e) {
      console.error(e);
      log("❌ Refresh Netzwerkfehler.", "err");
    }
  };

  // Systemstatus prüfen
  fetch("/api/ping")
    .then(r => r.json())
    .then(d => {
      const sys = document.getElementById("sys");
      const mode = document.getElementById("mode");

      if (!d.ok) {
        sys.textContent = "Systemstatus: Backend antwortet, aber ok=false.";
        sys.className = "pill err";
        return;
      }

      sys.textContent = `Systemstatus: Backend erreichbar • Rate-Limit: ${d.minIntervalMs}ms • Timeout: ${d.axiosTimeoutMs}ms`;
      sys.className = "pill ok";

      mode.textContent = `Auth: ${d.passwordMode} • Template TTL: ${Math.round((d.templateTtlMs||0)/60000)}min`;
      mode.className = "pill muted";

      // finalizeDefault setzen
      document.getElementById("finalize").checked = !!d.finalizeDefault;

      log("System bereit.", "ok");
    })
    .catch(() => {
      const sys = document.getElementById("sys");
      sys.textContent = "Systemstatus: ❌ Backend nicht erreichbar.";
      sys.className = "pill err";
      log("❌ Backend nicht erreichbar.", "err");
    });
</script>

</body>
</html>
